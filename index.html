<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub • iOS Theme</title>
    <meta name="theme-color" content="#0c4a6e" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <style>
      [x-cloak] {
        display: none !important;
      }
      .glass {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }
      .ios-bg {
        background: linear-gradient(
          135deg,
          #0c4a6e 0%,
          #1e40af 50%,
          #7c3aed 100%
        );
      }
      .ios-bg-light {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      }
      .ios-card {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .ios-text {
        font-weight: 500;
        letter-spacing: -0.5px;
      }
    </style>
  </head>

  <body
    class="min-h-screen text-white ios-bg pb-32"
    :class="{ 'ios-bg-light text-gray-900': !$store.dark }"
    x-data="app()"
    x-init="init()"
    @scroll.window.throttle.250="handlePageScroll"
  >
    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.store(
          "dark",
          window.matchMedia("(prefers-color-scheme: dark)").matches
        );
      });
    </script>

    <div class="max-w-md mx-auto p-6 pt-10">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-5xl font-bold tracking-tight ios-text">GitHub</h1>
        <p class="text-sm opacity-80 mt-1" x-text="currentTime"></p>
      </div>

      <!-- Search -->
      <div class="relative mb-8">
        <div class="flex items-center gap-3 ios-card rounded-3xl p-1">
          <input
            x-model="query"
            @input.debounce.500ms="searchUsers()"
            @focus="showSuggestions = true"
            @blur="setTimeout(() => showSuggestions = false, 200)"
            @keyup.enter="loadUserFromQuery()"
            placeholder="Search GitHub user..."
            class="flex-1 bg-transparent px-5 py-4 text-lg focus:outline-none ios-text"
          />
          <button @click="loadUserFromQuery()" class="p-3">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </button>
        </div>

        <!-- Autocomplete suggestions -->
        <div
          x-show="showSuggestions && suggestions.length"
          x-transition
          class="absolute top-full left-0 right-0 mt-3 ios-card rounded-3xl shadow-2xl z-50 max-h-64 overflow-y-auto"
        >
          <template x-for="s in suggestions" :key="s.login">
            <button
              @click="loadUser(s.login); showSuggestions = false;"
              class="flex items-center gap-4 w-full text-left p-4 hover:bg-white/10 transition"
            >
              <img
                :src="s.avatar_url"
                class="w-12 h-12 rounded-full"
                alt="avatar"
              />
              <div>
                <p class="font-medium ios-text" x-text="s.name || s.login"></p>
                <p class="text-sm opacity-70" x-text="'@' + s.login"></p>
              </div>
            </button>
          </template>
        </div>
      </div>

      <!-- Rate limit error -->
      <div
        x-show="rateLimitError"
        x-transition
        class="ios-card bg-orange-500/20 border border-orange-500/50 rounded-3xl p-6 mb-6 text-center"
      >
        <p class="text-lg font-bold">Too many requests</p>
        <p class="text-sm mt-2 opacity-90">
          GitHub temporarily limited access.
        </p>
        <p class="text-sm mt-3">Please wait a bit and try again.</p>
        <button
          @click="loadUser(query || 'torvalds')"
          class="mt-4 px-6 py-2 bg-white/20 rounded-full text-sm"
        >
          Try again
        </button>
      </div>

      <!-- Generic error -->
      <div
        x-show="error && !rateLimitError"
        x-transition
        class="ios-card bg-red-500/20 border border-red-500/50 rounded-3xl p-5 mb-6 text-center"
        x-text="error"
      ></div>

      <!-- User Profile and Repos -->
      <template x-if="user && !rateLimitError">
        <div
          x-transition:enter="transition duration-500 ease-out"
          x-transition:enter-start="opacity-0 translate-y-4"
          x-transition:enter-end="opacity-100 translate-y-0"
        >
          <!-- Profile card -->
          <div class="ios-card rounded-3xl p-6 mb-8 text-center">
            <img
              :src="user.avatar_url"
              class="w-28 h-28 rounded-full mx-auto ring-4 ring-white/30 mb-4"
            />
            <h2
              class="text-3xl font-bold ios-text"
              x-text="user.name || user.login"
            ></h2>
            <p class="text-lg opacity-80" x-text="'@' + user.login"></p>
            <p class="mt-3 text-sm" x-text="user.bio || 'No bio provided'"></p>

            <div class="grid grid-cols-3 gap-4 mt-6 text-sm">
              <div>
                <p class="opacity-70">Repos</p>
                <p class="text-2xl font-bold" x-text="user.public_repos"></p>
              </div>
              <div>
                <p class="opacity-70">Followers</p>
                <p class="text-2xl font-bold" x-text="user.followers"></p>
              </div>
              <div>
                <p class="opacity-70">Following</p>
                <p class="text-2xl font-bold" x-text="user.following"></p>
              </div>
            </div>
          </div>

          <!-- Repository list -->
          <div class="space-y-4">
            <template x-for="repo in repos" :key="repo.id">
              <div
                @click="openRepo(repo)"
                class="ios-card rounded-2xl p-5 cursor-pointer hover:ring-2 hover:ring-white/50 transition"
              >
                <h4 class="font-bold ios-text" x-text="repo.name"></h4>
                <p
                  class="text-sm opacity-70 mt-1"
                  x-text="repo.description || 'No description'"
                ></p>
                <div class="flex items-center gap-4 mt-3 text-sm">
                  <span class="flex items-center gap-1">
                    <!-- Stars -->
                    <svg
                      aria-label="stars"
                      role="img"
                      height="16"
                      width="16"
                      viewBox="0 0 16 16"
                      fill="currentColor"
                    >
                      <path
                        d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 
                    4.21.612a.75.75 0 0 1 .416 1.279l-3.046 
                    2.97.719 4.192a.751.751 0 0 1-1.088.791L8 
                    12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 
                    6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 
                    0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 
                    0 1-.564.41l-3.097.45 2.24 2.184a.75.75 
                    0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 
                    0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 
                    0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 
                    0 0 1-.564-.41L8 2.694Z"
                      />
                    </svg>
                    <span x-text="repo.stargazers_count"></span>
                  </span>
                  <span class="flex items-center gap-1">
                    <!-- Forks -->
                    <svg
                      aria-label="forks"
                      role="img"
                      height="16"
                      width="16"
                      viewBox="0 0 16 16"
                      fill="currentColor"
                    >
                      <path
                        d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 
                    0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 
                    0v.878a2.25 2.25 0 0 1-2.25 
                    2.25h-1.5v2.128a2.251 2.251 0 
                    1 1-1.5 0V8.5h-1.5A2.25 2.25 0 
                    0 1 3.5 6.25v-.878a2.25 2.25 0 
                    1 1 1.5 0ZM5 3.25a.75.75 0 1 
                    0-1.5 0 .75.75 0 0 0 1.5 
                    0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 
                    0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 
                    0-1.5 0 .75.75 0 0 0 1.5 0Z"
                      />
                    </svg>
                    <span x-text="repo.forks_count"></span>
                  </span>
                  <span x-text="repo.language || '—'"></span>
                  <span
                    class="opacity-60"
                    x-text="formatDate(repo.updated_at)"
                  ></span>
                </div>
              </div>
            </template>

            <!-- Loading indicator -->
            <div x-show="loadingMore" class="py-12 text-center">
              <div
                class="inline-block w-8 h-8 border-4 border-white/30 border-t-white rounded-full animate-spin"
              ></div>
              <p class="text-sm mt-3">Loading repositories...</p>
            </div>

            <!-- All repos loaded -->
            <div
              x-show="!hasMore && repos.length > 0"
              class="py-12 text-center text-sm opacity-70"
            >
              All <span x-text="repos.length"></span> of
              <span x-text="user.public_repos"></span> repositories loaded
            </div>
          </div>
        </div>
      </template>

      <!-- Loading skeleton -->
      <div
        x-show="loading && !user && !rateLimitError"
        class="space-y-6 animate-pulse"
      >
        <div class="h-48 ios-card rounded-3xl"></div>
        <div class="space-y-4">
          <div class="h-24 ios-card rounded-2xl"></div>
          <div class="h-24 ios-card rounded-2xl"></div>
          <div class="h-24 ios-card rounded-2xl"></div>
        </div>
      </div>

      <!-- Repository modal -->
      <template x-if="selectedRepo">
        <div
          x-transition
          class="fixed inset-0 glass bg-black/60 backdrop-blur-xl z-50 flex items-center justify-center p-6"
        >
          <div @click.stop class="ios-card rounded-3xl p-6 max-w-md w-full">
            <div class="flex justify-between items-start mb-4">
              <h3
                class="text-xl font-bold ios-text"
                x-text="selectedRepo.name"
              ></h3>
              <button @click="selectedRepo = null" class="p-2">Close</button>
            </div>
            <p
              x-text="selectedRepo.description || 'No description'"
              class="mb-4 text-sm"
            ></p>
            <div class="text-sm space-y-1">
              <p>
                <strong>Stars:</strong>
                <span x-text="selectedRepo.stargazers_count"></span>
              </p>
              <p>
                <strong>Forks:</strong>
                <span x-text="selectedRepo.forks_count"></span>
              </p>
              <p>
                <strong>Language:</strong>
                <span x-text="selectedRepo.language || '—'"></span>
              </p>
              <p>
                <strong>Updated:</strong>
                <span x-text="formatDate(selectedRepo.updated_at)"></span>
              </p>
            </div>
            <a
              :href="selectedRepo.html_url"
              target="_blank"
              class="block mt-6 text-center bg-white/20 rounded-2xl py-3 text-sm"
              >Open on GitHub</a
            >
          </div>
        </div>
      </template>
    </div>

    <!-- Bottom bar -->
    <div
      class="fixed bottom-0 left-0 right-0 glass bg-white/10 backdrop-blur-2xl border-t border-white/20 p-4"
    >
      <div class="max-w-md mx-auto flex justify-around text-xs">
        <button @click="$store.dark = !$store.dark" class="p-3">
          <span x-show="$store.dark">Light</span>
          <span x-show="!$store.dark">Dark</span>
        </button>
        <button @click="refreshCurrentUser()" class="p-3">Refresh</button>
      </div>
    </div>

    <script>
      function app() {
        return {
          query: "",
          suggestions: [],
          showSuggestions: false,
          user: null,
          repos: [],
          page: 1,
          perPage: 30,
          loading: false,
          loadingMore: false,
          hasMore: true,
          error: null,
          rateLimitError: false,
          selectedRepo: null,
          currentTime: "",

          async init() {
            this.updateTime();
            setInterval(() => this.updateTime(), 1000);
            await this.loadUser("torvalds");
          },

          async handleRateLimit(response) {
            if (response.status === 403) {
              this.rateLimitError = true;
              return true;
            }
            return false;
          },

          async searchUsers() {
            if (!this.query.trim()) {
              this.suggestions = [];
              return;
            }
            try {
              const res = await fetch(
                `https://api.github.com/search/users?q=${this.query}&per_page=5`
              );
              if (await this.handleRateLimit(res)) return;
              if (!res.ok) return;
              const data = await res.json();
              const users = data.items || [];

              this.suggestions = await Promise.all(
                users.map(async (u) => {
                  try {
                    const r = await fetch(
                      `https://api.github.com/users/${u.login}`
                    );
                    if (await this.handleRateLimit(r)) return u;
                    if (r.ok) {
                      const full = await r.json();
                      return { ...u, name: full.name || u.login };
                    }
                  } catch {}
                  return u;
                })
              );
            } catch {
              this.suggestions = [];
            }
          },

          async loadUser(login) {
            this.loading = true;
            this.error = null;
            this.rateLimitError = false;
            this.showSuggestions = false;
            this.user = null;
            this.repos = [];
            this.page = 1;
            this.hasMore = true;
            this.selectedRepo = null;
            this.query = login.trim();

            try {
              const userRes = await fetch(
                `https://api.github.com/users/${login}`
              );
              if (await this.handleRateLimit(userRes)) {
                this.loading = false;
                return;
              }
              if (!userRes.ok) throw new Error("User not found");
              this.user = await userRes.json();

              await this.loadMoreRepos(true);
              await this.$nextTick();
              window.scrollTo({ top: 0, behavior: "smooth" });
            } catch (e) {
              this.error = e.message;
            } finally {
              this.loading = false;
            }
          },

          async refreshCurrentUser() {
            if (this.user) await this.loadUser(this.user.login);
          },

          async loadMoreRepos(isInitial = false) {
            if (
              !this.user ||
              this.loadingMore ||
              !this.hasMore ||
              this.rateLimitError
            )
              return;
            this.loadingMore = true;

            try {
              const url = `https://api.github.com/users/${this.user.login}/repos?page=${this.page}&per_page=${this.perPage}&sort=updated&direction=desc`;
              const res = await fetch(url);
              if (await this.handleRateLimit(res)) {
                this.loadingMore = false;
                return;
              }

              const newRepos = await res.json();
              const existingIds = this.repos.map((r) => r.id);
              const filtered = newRepos.filter(
                (r) => !existingIds.includes(r.id)
              );
              this.repos.push(...filtered);
              this.page++;

              // Correct end condition
              if (
                newRepos.length < this.perPage ||
                this.repos.length >= this.user.public_repos
              ) {
                this.hasMore = false;
              }
            } catch (e) {
              console.error("Repo loading failed", e);
            } finally {
              this.loadingMore = false;
            }
          },

          async handlePageScroll() {
            if (this.loadingMore || !this.hasMore) return;
            const nearBottom =
              window.innerHeight + window.scrollY >=
              document.body.offsetHeight - 400;
            if (nearBottom) await this.loadMoreRepos();
          },

          openRepo(repo) {
            this.selectedRepo = repo;
          },

          loadUserFromQuery() {
            if (this.query.trim()) this.loadUser(this.query.trim());
          },

          updateTime() {
            const now = new Date();
            this.currentTime = now.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
          },

          formatDate(iso) {
            const d = new Date(iso);
            return d.toLocaleDateString([], { month: "short", day: "numeric" });
          },
        };
      }
    </script>
  </body>
</html>
